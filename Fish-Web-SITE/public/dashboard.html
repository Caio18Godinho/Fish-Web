<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>FishWeb | Dashboard</title>
   <link rel="stylesheet" href="./css/style.css">
   <script src="./js/sessao.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
   <div class="header">
      <div class="container">
         <h1 class="titulo">Fish<span style="font-weight: normal;">Web</span></h1>
         <ul class="navbar">
            <li class="agora">
               <a href="index.html">Inicial</a>
            </li>
            <li>
               <a href="login.html">Login</a>
            </li>
            <li>
               <a href="cadastro.html">Cadastro</a>
            </li>
         </ul>
      </div>
   </div>
   <div id="dash" style="background-image: url(./imgs/condominio-fechado-com-lago-para-pesca_capa.png); background-size: cover;">
      <div class="ola">
         <div>Olá, Pescador.</div>
      </div>
      <div class="kpis" id="div_kpis">
         <div class="kpi">
            <div>
               Maior pontuação:
               <p id="maior_pont"></p>
            </div>
         </div>
         <div class="kpi">
            <div>
               Menor pontuação:
               <p id="menor_pont"></p>
            </div>
         </div>
         <div class="kpi">
            <div>
               Partidas Jogadas:
               <p id="partidasJogadas"></p>
            </div>
         </div>
      </div>
      <div class="grafico">
         <div class="container_dash" id="grafico_Progressao">
            <canvas id="Progressao"></canvas>
         </div>
         <div class="kpi1">
            Ranking dos Usuarios:
            <p id="ranking"></p>
         </div>
      </div>
   </div>

   <div class="footer">
      <div class="container">
         <div class="foto"><img src="./imgs/f1.jpg"></div>
         <div>
            <h4>Meus contatos:</h4><a href="https://github.com/Caio18Godinho/Fish-Web.git">GitHub </a>
            <a href="">linkedin</a>
         </div><br>
      </div>
   </div>
</body>

</html>
<script>

   function listar() {
      var idusuario = sessionStorage.ID_USUARIO
      fetch(`/dash/listar/${idusuario}`)
         .then(resultado => resultado.json())
         .then(resultado => {
            console.log("Entrei listar")
            console.log(resultado)
            maior_pont.innerHTML = resultado[0].MelhorTentativa;
            menor_pont.innerHTML = resultado[0].PiorTentativa;
            partidasJogadas.innerHTML = resultado[0].partidas;

         })

         .catch(function (erro) {
            console.log('Erro frontend', erro);
         })
   }
    function exibir() {
       fetch("/dash/exibir")
          .then(resultado => resultado.json())
          .then(resultado => {
             console.log("Entrei exibir");
             console.log(resultado);
             ranking.innerHTML = "";
             for (var i = 0; i < resultado.length; i++) {
                var item = resultado[i];
                ranking.innerHTML += `${item.nome} - ${item.MelhoresTentativas}<br>`;
             }
          })
          .catch(function (erro) {
             console.log('Erro frontend', erro);
          });
    }

   function graf() {
      var idusuario = sessionStorage.ID_USUARIO
      fetch(`/dash/graf/${idusuario}`, { cache: "no-store" })
         .then(response => response.json())
         .then(function (response) {
            console.log("pedro", response);

            plotarGrafico(response);

         })
         .catch(function (error) {
            console.log(`Erro na obtenção dos dados p/ gráfico: ${error}`);
         });
      return false;
   }

   function plotarGrafico(listaDados) {
      var lista_vida_peixe = []
      var lista_questionario = []
      for (var i = 0; i < listaDados.length; i++) {
         var dado_atual = listaDados[i]
         var vida_atual = dado_atual.vida_peixe
         lista_vida_peixe.push(vida_atual)
      }
      for (var j = 0; j < listaDados.length; j++) {
         var dado_atual = listaDados[j]
         var quest_atual = dado_atual.idquestionario
         lista_questionario.push(quest_atual)
      }
      console.log('iniciando plotagem do gráfico...');

      let labels = lista_questionario

      let dados = {
         labels: labels,
         datasets: [{
            label: 'Progressão',
            data: lista_vida_peixe,
            fill: false,
            borderColor: 'rgb(14, 46, 0)',
            tension: 0.1
         }]
      };

      const config = {
         type: 'line',
         data: dados,
      };


      let myChart = new Chart(
         document.getElementById(`Progressao`),
         config
      );
      console.log('----------------------------------------------')
      console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')

   }


   listar();
   exibir();
   graf();
</script>